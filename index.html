<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>POS ‚Äî Sales & Inventory Management</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Point of Sale system with inventory management">
    <style>
        :root{--max:1200px;--accent:#0b76ef;--muted:#6b7280;--card:#f6f7f8;--panel:#eef1f3;--profit:#10b981;--loss:#ef4444}
        body{font-family:Segoe UI,Roboto,Arial,sans-serif;margin:16px;background:linear-gradient(180deg,#eef1f3 0%, #e6e9ec 100%);color:#111}
        .container{max-width:var(--max);margin:0 auto;padding:18px;background:linear-gradient(180deg,var(--card),#ffffff 60%);border-radius:8px;box-shadow:0 4px 10px rgba(30,40,50,.06)}
        h1{margin:0 0 12px;font-size:20px;color:#24303a}
        .grid{display:flex;gap:18px;flex-wrap:wrap}
        .card{flex:1 1 300px;padding:12px;border-radius:6px;background:var(--panel);border:1px solid rgba(30,40,50,.06)}
        .form-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
        label{min-width:100px;font-size:13px;color:var(--muted);font-weight:500}
        select,input[type=number],input[type=text],input[type=password]{flex:1;padding:8px;border:1px solid #d7dbe6;border-radius:4px;background:#fff}
        button{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:13px}
        button.ghost{background:#ffffff;color:var(--accent);border:1px solid #d6e8ff}
        button.danger{background:var(--loss)}
        table{width:100%;border-collapse:collapse;margin-top:8px;background:#fff;font-size:12px}
        th,td{padding:8px;border:1px solid #e6e9ef;text-align:left}
        th{background:#f3f5f7;color:#333;font-weight:600}
        .right{text-align:right}
        .small{font-size:11px;padding:4px 8px}
        .actions button{margin-right:4px}
        .summary{display:flex;gap:12px;flex-wrap:wrap;margin-top:8px}
        .summary .item{background:#fbfcfd;border:1px solid #e9eef2;padding:8px;border-radius:6px;min-width:140px}
        .summary .label{color:var(--muted);font-size:11px}
        .summary .value{font-weight:600;font-size:14px;color:#111}
        .tx-log{max-height:250px;overflow:auto}
        .subtle{color:#65707a;font-size:12px;margin-top:8px}
        .profit{color:var(--profit);font-weight:600}
        .loss{color:var(--loss);font-weight:600}
        input[type=file]{display:none}
        .search-container{position:relative}
        .dropdown-list{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #d7dbe6;border-top:none;max-height:150px;overflow-y:auto;z-index:10;display:none}
        .dropdown-list.active{display:block}
        .dropdown-item{padding:8px;cursor:pointer;border-bottom:1px solid #f0f0f0}
        .dropdown-item:hover{background:#f3f5f7}
        .modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:100;justify-content:center;align-items:center}
        .modal-overlay.active{display:flex}
        .modal{background:#fff;padding:24px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,.2);max-width:400px;width:90%}
        .modal h2{margin:0 0 16px;color:#24303a}
        .modal .form-row{flex-direction:column;align-items:flex-start}
        .modal label{min-width:auto;margin-bottom:4px}
        .github-info{background:#f8f9fa;border:1px solid #e1e4e8;border-radius:6px;padding:12px;margin:12px 0;font-size:12px}
        .github-info h4{margin:0 0 8px;color:#24292f}
        @media (max-width: 768px) {
            body{margin:8px}
            .container{padding:12px}
            .grid{flex-direction:column}
            .card{flex:1 1 auto}
            .form-row{flex-direction:column;align-items:flex-start}
            label{min-width:auto;margin-bottom:4px}
            .summary{justify-content:space-between}
            .summary .item{flex:1;min-width:120px}
        }
    </style>
</head>
<body>
    <div id="passwordModal" class="modal-overlay active">
        <div class="modal">
            <h2>üîê POS Login</h2>
            <div class="form-row">
                <label for="loginPassword">Enter Password</label>
                <input id="loginPassword" type="password" placeholder="Password" />
            </div>
            <div style="display:flex;gap:8px;margin-top:16px">
                <button id="loginBtn">Login</button>
                <button id="resetPasswordBtn" class="ghost">Reset to Default</button>
            </div>
        </div>
    </div>

    <div id="mainContent" style="display:none">
        <div class="container" role="main">
            <div class="github-info">
                <h4>üì± Access from Any Device</h4>
                <div>This POS system is hosted on GitHub Pages. Access from phone, tablet, or any computer with internet.</div>
            </div>
            
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <h1>POS ‚Äî Sales & Inventory</h1>
                <div style="display:flex;gap:12px;align-items:center">
                    <span id="currentUser">üë§ User</span>
                    <button id="logoutBtn" class="ghost">Logout</button>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <h3>Record Sale</h3>
                    <div class="form-row">
                        <label for="productSearch">Product</label>
                        <div class="search-container">
                            <input id="productSearch" type="text" placeholder="Type to search..." />
                            <div id="productDropdown" class="dropdown-list"></div>
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="quantity">Quantity</label>
                        <input id="quantity" type="number" min="1" step="1" value="1" />
                    </div>
                    <div class="form-row">
                        <label for="salePrice">Sale Price</label>
                        <input id="salePrice" type="number" min="0" step="0.01" value="0.00" />
                    </div>
                    <div class="form-row">
                        <label for="paymentMethod">Payment</label>
                        <select id="paymentMethod">
                            <option value="cash">Cash</option>
                            <option value="mpesa">Mpesa</option>
                        </select>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:8px">
                        <button id="recordBtn">Record Sale</button>
                        <button id="clearForm" class="ghost">Clear</button>
                    </div>
                    <div class="subtle">Profit = (Sale Price - Buying Price) √ó Qty</div>
                </div>

                <div class="card">
                    <h3>Add/Manage Products</h3>
                    <div class="form-row">
                        <label for="newName">Name</label>
                        <input id="newName" type="text" placeholder="Product name" />
                    </div>
                    <div class="form-row">
                        <label for="newStock">Stock</label>
                        <input id="newStock" type="number" min="0" step="1" value="0" />
                    </div>
                    <div class="form-row">
                        <label for="newBuyPrice">Buying Price</label>
                        <input id="newBuyPrice" type="number" min="0" step="0.01" value="0.00" />
                    </div>
                    <div class="form-row">
                        <label for="newLastPrice">Last Price</label>
                        <input id="newLastPrice" type="number" min="0" step="0.01" value="0.00" />
                    </div>
                    <div class="form-row">
                        <label for="newPrice">Selling Price</label>
                        <input id="newPrice" type="number" min="0" step="0.01" value="0.00" />
                    </div>
                    <div style="display:flex;gap:8px">
                        <button id="addProduct">Add Product</button>
                        <button id="resetDay" class="ghost">Reset Day</button>
                    </div>
                    <h4 style="margin-top:12px">Current Inventory</h4>
                    <table id="inventoryTable" aria-live="polite">
                        <thead>
                            <tr><th>Product</th><th class="right">Stock</th><th class="right">Buy</th><th class="right">Last</th><th class="right">Sell</th><th>Actions</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

                <div class="card">
                    <h3>Today's Summary</h3>
                    <div class="summary">
                        <div class="item"><div class="label">Cash Sales</div><div class="value" id="cashTotal">KES 0</div></div>
                        <div class="item"><div class="label">Mpesa Sales</div><div class="value" id="mpesaTotal">KES 0</div></div>
                        <div class="item"><div class="label">Total Revenue</div><div class="value" id="totalSales">KES 0</div></div>
                        <div class="item"><div class="label">Total Cost</div><div class="value" id="totalCost">KES 0</div></div>
                        <div class="item"><div class="label">Gross Profit</div><div class="value profit" id="totalProfit">KES 0</div></div>
                        <div class="item"><div class="label">Profit Margin</div><div class="value" id="marginPercent">0%</div></div>
                    </div>
                    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
                        <button id="exportCsv" class="ghost">Download CSV</button>
                        <button id="copyCsv" class="ghost">Copy CSV</button>
                        <input id="importInventoryFile" type="file" accept=".csv,text/csv" />
                        <button id="importInventory" class="ghost">Import CSV</button>
                        <button id="downloadReceipt" class="ghost">Receipt</button>
                    </div>
                    <h4 style="margin-top:12px">Transaction Log</h4>
                    <div class="tx-log">
                        <table id="txTable">
                            <thead><tr><th>Time</th><th>Product</th><th class="right">Qty</th><th class="right">Price</th><th class="right">Revenue</th><th class="right">Cost</th><th class="right">Profit</th><th>Payment</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const LS_KEYS = {INV: 'pos_inventory', SALES: 'pos_sales', TX: 'pos_transactions', PASS: 'pos_password'};
        const DEFAULT_INV = [
            {id:1, name:"Product A", stock:50, buyPrice:60.00, lastPrice:95.00, price:100.00},
            {id:2, name:"Product B", stock:30, buyPrice:120.00, lastPrice:190.00, price:200.00},
            {id:3, name:"Product C", stock:20, buyPrice:100.00, lastPrice:140.00, price:150.00}
        ];
        const DEFAULT_PASSWORD = '1234';

        const $ = id => document.getElementById(id);
        const fmt = v => Number(v).toLocaleString(undefined, {style:'currency', currency:'KES', minimumFractionDigits:2});
        const money = v => Math.round(Number(v)*100)/100;

        let inventory = loadJSON(LS_KEYS.INV) || DEFAULT_INV;
        let dailySales = loadJSON(LS_KEYS.SALES) || {cash:0, mpesa:0, total:0, totalCost:0, totalProfit:0};
        let transactions = loadJSON(LS_KEYS.TX) || [];
        let storedPassword = loadJSON(LS_KEYS.PASS) || DEFAULT_PASSWORD;
        let selectedProductId = null;

        function saveState() {
            localStorage.setItem(LS_KEYS.INV, JSON.stringify(inventory));
            localStorage.setItem(LS_KEYS.SALES, JSON.stringify(dailySales));
            localStorage.setItem(LS_KEYS.TX, JSON.stringify(transactions));
        }

        function loadJSON(key) {
            try {
                const v = localStorage.getItem(key);
                return v ? JSON.parse(v) : null;
            } catch(e) {
                console.error('loadJSON', e);
                return null;
            }
        }

        function handleLogin() {
            const pwd = $('loginPassword').value;
            if (pwd === storedPassword) {
                $('passwordModal').classList.remove('active');
                $('mainContent').style.display = 'block';
                $('loginPassword').value = '';
                initialize();
            } else {
                alert('Incorrect password!');
                $('loginPassword').value = '';
            }
        }

        function handleLogout() {
            if (confirm('Logout?')) {
                $('mainContent').style.display = 'none';
                $('passwordModal').classList.add('active');
                $('loginPassword').value = '';
                $('loginPassword').focus();
            }
        }

        function resetPassword() {
            const newPwd = prompt('Set new password (default: 1234):', DEFAULT_PASSWORD);
            if (newPwd !== null) {
                storedPassword = newPwd;
                localStorage.setItem(LS_KEYS.PASS, JSON.stringify(storedPassword));
                alert('Password updated!');
            }
        }

        function renderProductDropdown() {
            const dropdown = $('productDropdown');
            dropdown.innerHTML = '';
            inventory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.textContent = `${item.name} (${item.stock} in stock) ‚Äî ${fmt(item.price)}`;
                div.onclick = () => selectProduct(item.id);
                dropdown.appendChild(div);
            });
        }

        function selectProduct(id) {
            selectedProductId = id;
            const product = inventory.find(p => p.id === id);
            if (product) {
                $('productSearch').value = product.name;
                $('salePrice').value = product.price.toFixed(2);
                $('productDropdown').classList.remove('active');
            }
        }

        function filterProducts(query) {
            const dropdown = $('productDropdown');
            dropdown.innerHTML = '';
            const filtered = inventory.filter(p => 
                p.name.toLowerCase().includes(query.toLowerCase()) || String(p.id).includes(query)
            );
            
            if (filtered.length === 0) {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.textContent = 'No products found';
                dropdown.appendChild(div);
            } else {
                filtered.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'dropdown-item';
                    div.textContent = `${item.name} (${item.stock} stk) ‚Äî ${fmt(item.price)}`;
                    div.onclick = () => selectProduct(item.id);
                    dropdown.appendChild(div);
                });
            }
            dropdown.classList.add('active');
        }

        function renderInventory() {
            const tbody = document.querySelector('#inventoryTable tbody');
            tbody.innerHTML = '';

            inventory.forEach(item => {
                const row = tbody.insertRow();
                row.insertCell().textContent = item.name;
                const cStock = row.insertCell(); cStock.className = 'right'; cStock.textContent = item.stock;
                const cBuy = row.insertCell(); cBuy.className = 'right'; cBuy.textContent = fmt(item.buyPrice);
                const cLast = row.insertCell(); cLast.className = 'right'; cLast.textContent = fmt(item.lastPrice);
                const cSell = row.insertCell(); cSell.className = 'right'; cSell.textContent = fmt(item.price);
                const cActions = row.insertCell(); cActions.className = 'actions';

                const createBtn = (text, className, onClick) => {
                    const btn = document.createElement('button');
                    btn.textContent = text;
                    btn.className = `small ghost ${className}`;
                    btn.onclick = onClick;
                    return btn;
                };

                cActions.appendChild(createBtn('Receive', '', () => receiveStock(item.id)));
                cActions.appendChild(createBtn('Edit', '', () => editProduct(item.id)));
                cActions.appendChild(createBtn('Delete', 'danger', () => deleteProduct(item.id)));
            });
        }

        function recordSale() {
            if (!selectedProductId) { alert('Please select a product'); return; }
            const quantity = Math.floor(Number($('quantity').value) || 0);
            const salePrice = money(Number($('salePrice').value) || 0);
            const payment = $('paymentMethod').value;

            if (quantity <= 0) { alert('Enter a valid quantity (>=1).'); return; }
            if (salePrice <= 0) { alert('Enter a valid sale price.'); return; }

            const product = inventory.find(p => p.id === selectedProductId);
            if (!product) { alert('Product not found'); return; }

            if (salePrice < product.buyPrice) {
                alert(`Sale price (${fmt(salePrice)}) is below buying price (${fmt(product.buyPrice)}). Sale not allowed.`);
                return;
            }

            product.stock -= quantity;
            const revenue = money(salePrice * quantity);
            const cost = money(product.buyPrice * quantity);
            const profit = money(revenue - cost);

            dailySales[payment] = money((dailySales[payment] || 0) + revenue);
            dailySales.total = money((dailySales.total || 0) + revenue);
            dailySales.totalCost = money((dailySales.totalCost || 0) + cost);
            dailySales.totalProfit = money((dailySales.totalProfit || 0) + profit);

            transactions.unshift({
                time: new Date().toISOString(),
                product: product.name,
                qty: quantity,
                salePrice,
                revenue,
                cost,
                profit,
                payment,
                backorder: product.stock < 0
            });

            saveState();
            updateSalesDisplay();
            renderTransactions();
            renderInventory();
            renderProductDropdown();
            clearForm();
        }

        function addProduct() {
            const name = $('newName').value.trim();
            const stock = Number($('newStock').value) || 0;
            const buyPrice = money(Number($('newBuyPrice').value) || 0);
            const lastPrice = money(Number($('newLastPrice').value) || 0);
            const price = money(Number($('newPrice').value) || 0);

            if (!name) { alert('Product name required'); return; }
            if (buyPrice < 0 || price < 0 || stock < 0) { alert('Values cannot be negative'); return; }

            const newId = Math.max(0, ...inventory.map(p => p.id)) + 1;
            inventory.push({id: newId, name, stock, buyPrice, lastPrice: lastPrice || price, price});

            saveState();
            renderInventory();
            renderProductDropdown();
            
            $('newName').value = '';
            $('newStock').value = '0';
            $('newBuyPrice').value = '0.00';
            $('newLastPrice').value = '0.00';
            $('newPrice').value = '0.00';
        }

        function receiveStock(id) {
            const product = inventory.find(p => p.id === id);
            if (!product) return;
            
            const qty = prompt(`Add incoming stock for ${product.name}:`, '0');
            const quantity = Number(qty);
            if (quantity > 0) {
                product.stock += quantity;
                saveState();
                renderInventory();
                renderProductDropdown();
            }
        }

        function editProduct(id) {
            const product = inventory.find(p => p.id === id);
            if (!product) return;
            
            const newName = prompt('Product name:', product.name);
            if (newName === null) return;
            
            if (newName) product.name = newName.trim();
            if (Number(prompt('Stock:', product.stock)) !== null) product.stock = Number(event.returnValue);
            if (Number(prompt('Buying price:', product.buyPrice)) !== null) product.buyPrice = money(Number(event.returnValue));
            if (Number(prompt('Last price:', product.lastPrice)) !== null) product.lastPrice = money(Number(event.returnValue));
            if (Number(prompt('Selling price:', product.price)) !== null) product.price = money(Number(event.returnValue));
            
            saveState();
            renderInventory();
            renderProductDropdown();
        }

        function deleteProduct(id) {
            if (!confirm('Delete this product?')) return;
            inventory = inventory.filter(p => p.id !== id);
            saveState();
            renderInventory();
            renderProductDropdown();
        }

        function resetDay() {
            if (!confirm('Reset all sales data?')) return;
            dailySales = {cash:0, mpesa:0, total:0, totalCost:0, totalProfit:0};
            transactions = [];
            saveState();
            updateSalesDisplay();
            renderTransactions();
        }

        function updateSalesDisplay() {
            $('cashTotal').textContent = fmt(dailySales.cash || 0);
            $('mpesaTotal').textContent = fmt(dailySales.mpesa || 0);
            $('totalSales').textContent = fmt(dailySales.total || 0);
            $('totalCost').textContent = fmt(dailySales.totalCost || 0);
            $('totalProfit').textContent = fmt(dailySales.totalProfit || 0);
            
            const margin = dailySales.total > 0 ? (dailySales.totalProfit / dailySales.total * 100) : 0;
            $('marginPercent').textContent = `${margin.toFixed(1)}%`;
            $('marginPercent').className = `value ${margin >= 0 ? 'profit' : 'loss'}`;
        }

        function renderTransactions() {
            const tbody = document.querySelector('#txTable tbody');
            tbody.innerHTML = '';
            
            transactions.forEach(tx => {
                const row = tbody.insertRow();
                const time = new Date(tx.time).toLocaleTimeString();
                row.insertCell().textContent = time;
                row.insertCell().textContent = tx.product + (tx.backorder ? ' üì¶' : '');
                row.insertCell().className = 'right'; row.lastChild.textContent = tx.qty;
                row.insertCell().className = 'right'; row.lastChild.textContent = fmt(tx.salePrice);
                row.insertCell().className = 'right'; row.lastChild.textContent = fmt(tx.revenue);
                row.insertCell().className = 'right'; row.lastChild.textContent = fmt(tx.cost);
                const profitCell = row.insertCell(); 
                profitCell.className = `right ${tx.profit >= 0 ? 'profit' : 'loss'}`;
                profitCell.textContent = fmt(tx.profit);
                row.insertCell().textContent = tx.payment;
            });
        }

        function clearForm() {
            $('productSearch').value = '';
            $('quantity').value = '1';
            $('salePrice').value = '0.00';
            selectedProductId = null;
        }

        function exportCsv() {
            let csv = 'Product,Stock,Buying Price,Last Price,Selling Price\n';
            inventory.forEach(p => {
                csv += `"${p.name}",${p.stock},${p.buyPrice},${p.lastPrice},${p.price}\n`;
            });
            
            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function copyCsv() {
            let csv = 'Product,Stock,Buying Price,Last Price,Selling Price\n';
            inventory.forEach(p => {
                csv += `"${p.name}",${p.stock},${p.buyPrice},${p.lastPrice},${p.price}\n`;
            });
            navigator.clipboard.writeText(csv).then(() => alert('CSV copied!'));
        }

        function handleCsvImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = e => {
                const lines = e.target.result.split('\n').slice(1);
                const newInventory = [];
                
                lines.forEach(line => {
                    if (!line.trim()) return;
                    const [name, stock, buyPrice, lastPrice, price] = line.split(',');
                    if (name) {
                        newInventory.push({
                            id: newInventory.length + 1,
                            name: name.replace(/"/g, ''),
                            stock: Number(stock) || 0,
                            buyPrice: money(Number(buyPrice) || 0),
                            lastPrice: money(Number(lastPrice) || 0),
                            price: money(Number(price) || 0)
                        });
                    }
                });
                
                if (newInventory.length > 0 && confirm(`Import ${newInventory.length} products?`)) {
                    inventory = newInventory;
                    saveState();
                    renderInventory();
                    renderProductDropdown();
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function downloadReceipt() {
            if (transactions.length === 0) { alert('No transactions'); return; }
            
            let receipt = 'POS RECEIPT\n';
            receipt += `Date: ${new Date().toLocaleDateString()}\n`;
            receipt += `Time: ${new Date().toLocaleTimeString()}\n`;
            receipt += '========================\n';
            
            transactions.forEach(tx => {
                receipt += `${tx.product} x${tx.qty} = ${fmt(tx.revenue)}\n`;
            });
            
            receipt += `========================\nTOTAL: ${fmt(dailySales.total)}\n`;
            receipt += `PROFIT: ${fmt(dailySales.totalProfit)}\n`;
            
            const blob = new Blob([receipt], {type:'text/plain'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `receipt-${new Date().toISOString().split('T')[0]}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function initialize() {
            renderInventory();
            updateSalesDisplay();
            renderTransactions();
            renderProductDropdown();
            
            $('loginBtn').onclick = handleLogin;
            $('logoutBtn').onclick = handleLogout;
            $('resetPasswordBtn').onclick = resetPassword;
            $('recordBtn').onclick = recordSale;
            $('addProduct').onclick = addProduct;
            $('resetDay').onclick = resetDay;
            $('exportCsv').onclick = exportCsv;
            $('copyCsv').onclick = copyCsv;
            $('importInventory').onclick = () => $('importInventoryFile').click();
            $('importInventoryFile').onchange = handleCsvImport;
            $('downloadReceipt').onclick = downloadReceipt;
            $('clearForm').onclick = clearForm;
            
            $('productSearch').oninput = e => filterProducts(e.target.value);
            $('productSearch').onfocus = () => renderProductDropdown();
            $('loginPassword').onkeypress = e => e.key === 'Enter' && handleLogin();
            
            document.addEventListener('click', e => {
                if (!e.target.closest('.search-container')) {
                    $('productDropdown').classList.remove('active');
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initialize();
            $('loginPassword').focus();
        });
    </script>
</body>
</html> 
